# Axon Production Docker Compose
# For production deployments with multiple replicas and NGINX load balancer

version: '3.8'

services:
  # ==============================================
  # NGINX Load Balancer
  # ==============================================
  nginx:
    image: nginx:alpine
    container_name: axon-nginx
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - api
    networks:
      - axon-network
    healthcheck:
      test: ['CMD', 'nginx', '-t']
      interval: 30s
      timeout: 10s
      retries: 3

  # ==============================================
  # API Gateway (Multiple Replicas)
  # ==============================================
  api:
    image: axon-api:${VERSION:-latest}
    restart: unless-stopped
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
    environment:
      NODE_ENV: production
      PORT: 3000
      MONGODB_URI: ${MONGODB_URI}
      REDIS_HOST: ${REDIS_HOST}
      QDRANT_URL: ${QDRANT_URL}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      JWT_SECRET: ${JWT_SECRET}
      LOG_LEVEL: warn
      LOG_FORMAT: json
      CORS_ORIGIN: ${CORS_ORIGIN}
    networks:
      - axon-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/v1/health']
      interval: 30s
      timeout: 10s
      retries: 3

  # ==============================================
  # MongoDB (Production)
  # ==============================================
  mongodb:
    image: mongo:6
    container_name: axon-mongodb-prod
    restart: unless-stopped
    ports:
      - '27017:27017'
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: axon
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
      - ./backups/mongodb:/backups
    networks:
      - axon-network
    command: >
      mongod
      --auth
      --bind_ip_all
      --wiredTigerCacheSizeGB 2

  # ==============================================
  # Redis (Production)
  # ==============================================
  redis:
    image: redis:7-alpine
    container_name: axon-redis-prod
    restart: unless-stopped
    ports:
      - '6379:6379'
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --appendfsync everysec
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
      - ./backups/redis:/backups
    networks:
      - axon-network

  # ==============================================
  # Qdrant (Production)
  # ==============================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: axon-qdrant-prod
    restart: unless-stopped
    ports:
      - '6333:6333'
      - '6334:6334'
    volumes:
      - qdrant-data:/qdrant/storage
      - ./backups/qdrant:/backups
    networks:
      - axon-network
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__STORAGE__PERFORMANCE__OPTIMIZERS__INDEXING_THRESHOLD: 20000

volumes:
  mongodb-data:
    driver: local
  mongodb-config:
    driver: local
  redis-data:
    driver: local
  qdrant-data:
    driver: local

networks:
  axon-network:
    driver: bridge
